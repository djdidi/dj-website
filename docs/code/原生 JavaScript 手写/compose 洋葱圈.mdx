---
sidebar_position: 12
---

## ğŸ§…koa-compose æ ¸å¿ƒå®ç°

[https://github.com/koajs/compose æºç ](https://github.com/koajs/compose)

å»é™¤äº†ä¸€äº›æºç ä¸­æ ¡éªŒé€»è¾‘ï¼Œåªä¿ç•™æ ¸å¿ƒé€»è¾‘åˆ†æã€‚

```typescript title="koa-compose æ ¸å¿ƒæºç "
/**
 * middlewares æ˜¯ä»€ä¹ˆï¼Ÿ
 * - app.use push middlewares
 * - callback = compose(middlewares)
 *
 * compose ä½œç”¨ï¼Ÿ
 * - æŠŠè¿™ä¸ªä¸­é—´ä»¶æ•°ç»„åˆå¹¶æˆä¸€ä¸ªå¤§çš„ä¸­é—´ä»¶å‡½æ•°ï¼Œåƒæ´‹è‘±åœˆ ğŸ§… ä¸€æ ·è°ƒç”¨
 * - ä¸­é—´ä»¶å‡½æ•°çš„è°ƒç”¨æ—¶æœºç”± next å†³å®šï¼šä¸­é—´ä»¶å‡½æ•°æ¥æ”¶ next å‚æ•°ï¼Œå†³å®šä¸‹ä¸€ä¸ªå‡½æ•°æ‰§è¡Œï¼Œnext() æ‰§è¡Œå®Œï¼Œå½“å‰å‡½æ•°ç»§ç»­è·‘ã€‚
 */
function compose(middlewares: Function[]) {

  // è¿”å›æ•´åˆåçš„å‡½æ•°
  return function (context: any, next: Function) {
    let index = -1;

    // æ‰§è¡Œç¬¬ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°
    return dispatch(0);

    function dispatch(i: number) {
      if (i <= index) return Promise.reject(new Error('next() called multiple times'));

      index = i;
      // å½“å‰ä¸­é—´ä»¶å‡½æ•°
      let fn = middlewares[i];

      /**
      * åœ¨æœ€åä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°è°ƒç”¨ next() ä¼šå‘½ä¸­ä¸‹é¢
      * TODO:
      * - â“â“â“è¿™ä¸ª next æ˜¯ä¸ ctx åŒæ—¶ä¼ å…¥çš„ï¼Œåˆ°æ´‹è‘±å¿ƒæ—¶é€šçŸ¥ä¸‹å¤–é¢ï¼Ÿ åº”è¯¥å« onReachOnionInnerCallback?
      * - ä¸çŸ¥é“å¹²å•¥ç”¨ï¼Œkoa æœ¬èº«ä¹Ÿæ²¡ç”¨ï¼Œåªä¼ äº† ctx å‚æ•°ã€‚
      */
      if (i === middlewares.length) fn = next;
      // é€’å½’ç»“æŸæ¡ä»¶(æ´‹è‘±å¿ƒâ¤ï¸)ï¼Œç”±å†…å‘å¤–æ‰§è¡Œ next() ä¹‹åçš„éƒ¨åˆ†
      if (!fn) return Promise.resolve();

      try {
        /**
        * 1.è°ƒç”¨å½“å‰ä¸­é—´ä»¶å‡½æ•° fn
        * 2.è°ƒç”¨ next() === è°ƒç”¨ dispatch()ï¼ˆä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„æ‰§è¡Œæƒï¼Œåœ¨ä¸Šä¸€ä¸ªä¸­é—´ä»¶æ‰‹ä¸­ï¼‰
        */
        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));
      } catch (err) {
        return Promise.reject(err);
      }
    }
  };
}
```

---

![koa-compose](https://djcdn-1257815770.cos.ap-guangzhou.myqcloud.com/koa-componse.png)
